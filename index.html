<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>공동계약 확인서 - 수수료 쉐어 시스템</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- 외부 라이브러리: 엑셀, PDF -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7;
      color: #222;
    }
    .layout {
      display: flex;
      min-height: 100vh;
    }
    .main {
      flex: 1;
      padding: 24px;
      display: grid;
      grid-template-columns: 1.1fr 1.1fr;
      grid-gap: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      grid-column: 1 / -1;
      margin: 0 0 8px;
      font-size: 22px;
      font-weight: 700;
    }
    .subtitle {
      grid-column: 1 / -1;
      margin-bottom: 16px;
      color: #666;
      font-size: 13px;
    }
    .card {
      background: white;
      border-radius: 18px;
      padding: 18px 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    }
    .card h2 {
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 16px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 12px;
      margin-bottom: 10px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }
    label {
      color: #555;
    }
    input, select {
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #d0d0d7;
      font-size: 13px;
      outline: none;
    }
    input:focus, select:focus {
      border-color: #ffb400;
      box-shadow: 0 0 0 1px rgba(255, 179, 0, 0.3);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 4px;
      text-align: center;
    }
    th {
      background: #fafafa;
    }
    .btn-panel {
      width: 190px;
      padding: 24px 16px;
      border-left: 1px solid #e0e0e5;
      background: #fcfcfd;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 13px;
      cursor: pointer;
      display: block;
      width: 100%;
      text-align: center;
      background: #ffcc33;
      font-weight: 600;
      color: #333;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .btn-secondary {
      background: #fff;
      border: 1px solid #ddd;
      box-shadow: none;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .status {
      font-size: 12px;
      color: #777;
      margin-top: 8px;
    }
    .contract-index {
      font-size: 12px;
      margin-top: 12px;
      text-align: center;
      color: #444;
    }
    .contract-index span {
      font-weight: 600;
    }
    .preview-header {
      text-align: center;
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 15px;
    }
    .preview-subtable {
      margin-bottom: 12px;
    }
    @media (max-width: 960px) {
      .layout {
        flex-direction: column;
      }
      .main {
        grid-template-columns: 1fr;
      }
      .btn-panel {
        width: 100%;
        border-left: none;
        border-top: 1px solid #e0e0e5;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
      }
      .btn {
        width: calc(50% - 10px);
      }
    }
  </style>
</head>
<body>
<div class="layout">
  <div class="main">
    <h1>공동계약 수수료 쉐어 관리</h1>
    <div class="subtitle">
      계약 정보를 입력하면 오른쪽 버튼으로 엑셀/빈양식/PDF를 생성하고,
      여러 건의 계약을 이전·다음으로 저장/조회할 수 있습니다.
    </div>

    <!-- 입력 영역 -->
    <div class="card" id="input-card">
      <h2>1. 계약 기본정보</h2>
      <div class="form-row">
        <div class="field">
          <label for="contractNumber">증권번호 / 계약번호</label>
          <input id="contractNumber" />
        </div>
        <div class="field">
          <label for="insurer">보험사</label>
          <input id="insurer" />
        </div>
      </div>
      <div class="form-row">
        <div class="field">
          <label for="contractDate">계약확정일</label>
          <input id="contractDate" type="date" />
        </div>
        <div class="field">
          <label for="policyHolder">계약자 / 피보험자</label>
          <input id="policyHolder" />
        </div>
      </div>

      <h2 style="margin-top:18px;">2. 공동모집자 기여율</h2>
      <table>
        <thead>
          <tr>
            <th style="width:60px;">구분</th>
            <th style="width:70px;">기여율(%)</th>
            <th>사번</th>
            <th>성명</th>
            <th>서명(텍스트)</th>
          </tr>
        </thead>
        <tbody id="participants-body">
        <!-- JS에서 1~5행 자동 생성 -->
        </tbody>
      </table>
      <div class="status" id="statusText"></div>
    </div>

    <!-- 미리보기 & PDF 영역 -->
    <div class="card" id="preview-card">
      <div id="pdfArea">
        <div class="preview-header">공동계약 확인서</div>

        <table class="preview-subtable">
          <tbody>
          <tr>
            <th style="width:90px;">보험사</th>
            <td id="pv_insurer"></td>
            <th style="width:90px;">증권번호</th>
            <td id="pv_contractNumber"></td>
          </tr>
          <tr>
            <th>계약확정일</th>
            <td id="pv_contractDate"></td>
            <th>계약자/피보험자</th>
            <td id="pv_policyHolder"></td>
          </tr>
          </tbody>
        </table>

        <table>
          <thead>
          <tr>
            <th style="width:60px;">구분</th>
            <th style="width:70px;">기여율(%)</th>
            <th>사번</th>
            <th>성명</th>
            <th>서명</th>
          </tr>
          </thead>
          <tbody id="pv_participants">
          <!-- JS에서 렌더링 -->
          </tbody>
        </table>

        <div style="margin-top:16px; font-size:11px; line-height:1.4; color:#555;">
          1) 상기 계약에 관한 제반 사항은 영업지점 기준에 따릅니다.<br/>
          2) 공동모집자 기여율은 상호 협의에 의해 산정하였으며, 기여율 합계는 100%입니다.<br/>
          3) 기타 수수료 지급 및 정산 기준은 회사의 관련 규정에 따릅니다.
        </div>

        <div style="margin-top:26px; text-align:right; font-size:12px;">
          <span id="pv_today"></span><br/>
          모기지리더스㈜ 귀중
        </div>
      </div>
    </div>
  </div>

  <!-- 버튼 패널 -->
  <div class="btn-panel">
    <button class="btn" id="btnExcelUpload">엑셀 파일로 자동 입력</button>
    <input type="file" id="excelFileInput" style="display:none" accept=".xlsx,.xls" />

    <button class="btn" id="btnExcelDownload">엑셀 양식 다운로드</button>
    <button class="btn btn-secondary" id="btnBlankExcel">빈양식 다운로드</button>

    <button class="btn btn-secondary" id="btnReset">정보 초기화</button>

    <button class="btn btn-secondary" id="btnPrev">이전 계약</button>
    <button class="btn btn-secondary" id="btnNext">다음 계약</button>

    <button class="btn" id="btnPdf">PDF로 저장</button>

    <div class="contract-index" id="contractIndex"></div>
  </div>
</div>

<script>
  // ---------- 상태 관리 ----------
  let contracts = [];         // { basic: {}, participants: [] } 형태
  let currentIndex = 0;       // 현재 보고 있는 계약 index

  const MAX_PARTICIPANTS = 5;

  function initParticipantsRows() {
    const tbody = document.getElementById('participants-body');
    tbody.innerHTML = '';
    for (let i = 0; i < MAX_PARTICIPANTS; i++) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>공동${i === 0 ? '주' : '모집자' + i}</td>
        <td><input data-field="share" data-row="${i}" type="number" min="0" max="100" step="0.1"></td>
        <td><input data-field="staffId" data-row="${i}"></td>
        <td><input data-field="name" data-row="${i}"></td>
        <td><input data-field="sign" data-row="${i}"></td>
      `;
      tbody.appendChild(tr);
    }
  }

  function getFormData() {
    const basic = {
      contractNumber: document.getElementById('contractNumber').value.trim(),
      insurer: document.getElementById('insurer').value.trim(),
      contractDate: document.getElementById('contractDate').value,
      policyHolder: document.getElementById('policyHolder').value.trim(),
    };
    const participants = [];
    for (let i = 0; i < MAX_PARTICIPANTS; i++) {
      const row = {
        label: i === 0 ? '주모집자' : `공동모집자${i}`,
        share: getInputValue('share', i),
        staffId: getInputValue('staffId', i),
        name: getInputValue('name', i),
        sign: getInputValue('sign', i),
      };
      participants.push(row);
    }
    return { basic, participants };
  }

  function setFormData(data) {
    const basic = data.basic || {};
    document.getElementById('contractNumber').value = basic.contractNumber || '';
    document.getElementById('insurer').value = basic.insurer || '';
    document.getElementById('contractDate').value = basic.contractDate || '';
    document.getElementById('policyHolder').value = basic.policyHolder || '';

    if (data.participants && data.participants.length) {
      data.participants.forEach((row, idx) => {
        if (idx >= MAX_PARTICIPANTS) return;
        setInputValue('share', idx, row.share || '');
        setInputValue('staffId', idx, row.staffId || '');
        setInputValue('name', idx, row.name || '');
        setInputValue('sign', idx, row.sign || '');
      });
    } else {
      for (let i = 0; i < MAX_PARTICIPANTS; i++) {
        setInputValue('share', i, '');
        setInputValue('staffId', i, '');
        setInputValue('name', i, '');
        setInputValue('sign', i, '');
      }
    }
    syncPreview();
  }

  function getInputValue(field, row) {
    const el = document.querySelector(`input[data-field="${field}"][data-row="${row}"]`);
    return el ? el.value.trim() : '';
  }
  function setInputValue(field, row, val) {
    const el = document.querySelector(`input[data-field="${field}"][data-row="${row}"]`);
    if (el) el.value = val;
  }

  function saveCurrentToState() {
    contracts[currentIndex] = getFormData();
    localStorage.setItem('jointContracts', JSON.stringify(contracts));
    updateIndexText();
  }

  function loadStateFromStorage() {
    const saved = localStorage.getItem('jointContracts');
    if (saved) {
      try {
        contracts = JSON.parse(saved);
      } catch (e) {
        console.error(e);
        contracts = [];
      }
    }
    if (!contracts.length) {
      contracts.push(getFormData()); // 빈 계약 하나
    }
    currentIndex = 0;
    setFormData(contracts[0]);
    updateIndexText();
  }

  function updateIndexText() {
    const el = document.getElementById('contractIndex');
    el.innerHTML = `<span>${currentIndex + 1}</span> / ${contracts.length} 건`;
  }

  // ---------- 미리보기 렌더링 ----------
  function syncPreview() {
    const { basic, participants } = getFormData();
    document.getElementById('pv_insurer').innerText = basic.insurer || '';
    document.getElementById('pv_contractNumber').innerText = basic.contractNumber || '';
    document.getElementById('pv_contractDate').innerText = basic.contractDate || '';
    document.getElementById('pv_policyHolder').innerText = basic.policyHolder || '';

    const tbody = document.getElementById('pv_participants');
    tbody.innerHTML = '';
    participants.forEach((row, idx) => {
      // 모두 빈 줄이면 출력 안 함
      if (!row.share && !row.staffId && !row.name && !row.sign) return;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx === 0 ? '주모집자' : '공동모집자' + idx}</td>
        <td>${row.share || ''}</td>
        <td>${row.staffId || ''}</td>
        <td>${row.name || ''}</td>
        <td>${row.sign || ''}</td>
      `;
      tbody.appendChild(tr);
    });

    // 오늘 날짜 표시
    const todayEl = document.getElementById('pv_today');
    const today = new Date();
    todayEl.innerText = `${today.getFullYear()}년 ${today.getMonth()+1}월 ${today.getDate()}일`;
  }

  // ---------- 엑셀 다운로드 ----------
  function downloadExcel(fromBlank = false) {
    const data = fromBlank ? {
      basic: {},
      participants: Array.from({ length: MAX_PARTICIPANTS }, (_, i) => ({
        label: i === 0 ? '주모집자' : `공동모집자${i}`,
        share: '',
        staffId: '',
        name: '',
        sign: '',
      }))
    } : getFormData();

    const rows = [];
    // 기본정보 행
    rows.push(['항목', '값']);
    rows.push(['보험사', data.basic.insurer || '']);
    rows.push(['증권번호/계약번호', data.basic.contractNumber || '']);
    rows.push(['계약확정일', data.basic.contractDate || '']);
    rows.push(['계약자/피보험자', data.basic.policyHolder || '']);
    rows.push([]); // 빈 줄

    // 공동모집자 표
    rows.push(['구분', '기여율(%)', '사번', '성명', '서명']);
    data.participants.forEach(p => {
      rows.push([p.label, p.share || '', p.staffId || '', p.name || '', p.sign || '']);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, '공동계약');

    const fileName = fromBlank
      ? '공동계약_빈양식.xlsx'
      : `공동계약_${(data.basic.contractNumber || '양식')}.xlsx`;
    XLSX.writeFile(wb, fileName);
  }

  // ---------- 엑셀 업로드 → 자동 입력 ----------
  function handleExcelUpload(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheetName = workbook.SheetNames[0];
      const ws = workbook.Sheets[firstSheetName];
      const sheetData = XLSX.utils.sheet_to_json(ws, { header: 1 });

      // ★ 여기부터는 "우리 회사 엑셀 양식"에 맞게 매핑만 바꾸면 됩니다.
      // 예시: 위에서 만든 양식 그대로 읽는 로직
      const result = {
        basic: {
          insurer: (sheetData[1] && sheetData[1][1]) || '',
          contractNumber: (sheetData[2] && sheetData[2][1]) || '',
          contractDate: (sheetData[3] && sheetData[3][1]) || '',
          policyHolder: (sheetData[4] && sheetData[4][1]) || '',
        },
        participants: []
      };

      // 7번째 줄 이후에 공동모집자 데이터가 있다고 가정 (예시 양식 기준)
      for (let r = 7; r < sheetData.length && r < 7 + MAX_PARTICIPANTS; r++) {
        const row = sheetData[r] || [];
        if (!row.length) continue;
        result.participants.push({
          label: row[0] || '',
          share: row[1] || '',
          staffId: row[2] || '',
          name: row[3] || '',
          sign: row[4] || '',
        });
      }

      setFormData(result);
      saveCurrentToState();
      setStatus('엑셀에서 데이터를 불러왔습니다.');
    };
    reader.readAsArrayBuffer(file);
  }

  // ---------- PDF 저장 ----------
  function downloadPdf() {
    const element = document.getElementById('pdfArea');
    const opt = {
      margin:       10,
      filename:     `공동계약_${document.getElementById('contractNumber').value || '확인서'}.pdf`,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2 },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
  }

  // ---------- 기타 UI ----------
  function setStatus(msg) {
    document.getElementById('statusText').innerText = msg || '';
  }

  // 이벤트 바인딩
  function bindEvents() {
    // 입력값이 바뀔 때마다 미리보기 & 상태 업데이트
    document.getElementById('input-card').addEventListener('input', () => {
      syncPreview();
      saveCurrentToState();
    });

    document.getElementById('btnExcelDownload').addEventListener('click', () => {
      downloadExcel(false);
    });

    document.getElementById('btnBlankExcel').addEventListener('click', () => {
      downloadExcel(true);
    });

    document.getElementById('btnExcelUpload').addEventListener('click', () => {
      document.getElementById('excelFileInput').click();
    });

    document.getElementById('excelFileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        handleExcelUpload(file);
        e.target.value = ''; // 같은 파일 다시 선택 가능하게 초기화
      }
    });

    document.getElementById('btnPdf').addEventListener('click', () => {
      downloadPdf();
    });

    document.getElementById('btnReset').addEventListener('click', () => {
      if (!confirm('현재 계약 정보를 모두 초기화하시겠습니까?')) return;
      setFormData({ basic: {}, participants: [] });
      saveCurrentToState();
      setStatus('현재 계약 정보가 초기화되었습니다.');
    });

    document.getElementById('btnPrev').addEventListener('click', () => {
      if (currentIndex === 0) {
        alert('첫 번째 계약입니다.');
        return;
      }
      saveCurrentToState();
      currentIndex -= 1;
      setFormData(contracts[currentIndex]);
      updateIndexText();
    });

    document.getElementById('btnNext').addEventListener('click', () => {
      saveCurrentToState();
      if (currentIndex === contracts.length - 1) {
        // 새 계약 추가
        contracts.push({ basic: {}, participants: [] });
        currentIndex = contracts.length - 1;
        setFormData(contracts[currentIndex]);
      } else {
        currentIndex += 1;
        setFormData(contracts[currentIndex]);
      }
      updateIndexText();
    });
  }

  // 초기화
  (function init() {
    initParticipantsRows();
    bindEvents();
    loadStateFromStorage();
    syncPreview();
  })();
</script>
</body>
</html>
